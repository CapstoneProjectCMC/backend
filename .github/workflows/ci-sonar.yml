name:
  CI & SonarQube
on:
  push:
    branches: [ "**" ]
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  build-test-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Sonar cần có full history để tính "blame"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build & Test
        run: mvn -B -DskipTests=false -Dmaven.test.failure.ignore=true verify

      - name: Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
          if-no-files-found: ignore
          
      - name: SonarQube Scan
        env:
          #          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          #          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: f3d4a7c57b1c39eaebcc3d05496d56ca407d7872
          SONAR_HOST_URL: https://sonarcloud.io
        run: |
          if [ -z "$SONAR_TOKEN" ] || [ -z "$SONAR_HOST_URL" ]; then
            echo "SONAR_* secrets chưa được cấu hình => bỏ qua phân tích Sonar."
            exit 0
          fi
          mvn -B -DskipTests=true \
            -Dsonar.coverage.jacoco.xmlReportPaths='**/target/site/**/jacoco*.xml' \
            sonar:sonar
